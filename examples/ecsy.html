<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="../src/ecsy/fullscreen.css">
    <link rel="stylesheet" href="../src/ecsy/webxr.css">
    <style type="text/css">
        html, body {
            padding: 0;
            margin:0;
            overflow: hidden;
        }

        div.dom-dashboard {
            border: 5px solid black;
            z-index: 10;
            position: fixed;
            top: 10vh;
            left: 10vw;
            right: 10vw;
            bottom: 10vh;
            background: white;
            opacity: 0.8;
            display: none;
        }
        div.dom-dashboard img {
            width: 10vw;
            image-rendering: crisp-edges;
            border: 5px solid black;
            padding: 5px;
            margin: 5px;
            background-color: white;
        }
        div.dom-dashboard.visible {
            display: block;
        }
        div.dom-dashboard button {
            position: absolute;
            bottom:0;
            right:0;
            font-size: 200%;
        }

    </style>
</head>
<body>

<script type="module">
    import {Group,
        Vector3,
        TextureLoader,
        CubeGeometry,
        MeshLambertMaterial,
        Mesh,
        AmbientLight,
    } from '../node_modules/three/build/three.module.js';
    import { Component, System, World } from '../node_modules/ecsy/build/ecsy.module.js?module';
    import {
        initialize,
        Parent,
        Transform,
        Object3D,
    } from '../node_modules/ecsy-three/build/ecsy-three.module-unpkg.js';
    import * as util from "../src/utils.js"
    import {MouseCursor, MouseSystem} from '../src/ecsy/mouse.js'
    import {KeyboardControls, KeyboardSystem} from '../src/ecsy/keyboard.js'
    import {VoxelLandscape, VoxelSystem, VoxelTextures} from '../src/ecsy/voxels.js'
    import {ActiveBlock, Highlight, HighlightSystem} from '../src/ecsy/highlight.js'
    import {StagePosition, StageRotation} from '../src/ecsy/camera_gimbal.js'
    import {WebXRSystem, WebXRButton} from '../src/ecsy/webxr.js'
    import {FullscreenSystem, FullscreenButton} from '../src/ecsy/fullscreen.js'


    class DomDashboard extends Component {
        constructor() {
            super();
            this.domElement = null
        }
    }

    class DashboardVisible extends Component {

    }

    class DashboardDOMOvleraySystem extends System {
        execute(delta, time) {
            this.queries.dash.added.forEach(me=>{
                const dash = me.getComponent(DomDashboard);
                let div = document.createElement('div');
                div.classList.add("dom-dashboard");
                div.addEventListener('mousedown',e => e.stopPropagation());
                div.addEventListener('mouseup',e => e.stopPropagation());
                div.addEventListener('mousemove',e => e.stopPropagation());
                document.documentElement.append(div)

                this.queries.textures.results.forEach(ent => {
                    console.log("textures are", ent.getComponent(VoxelTextures))
                    let texs = ent.getComponent(VoxelTextures).textures
                    texs.forEach((tex,i) => {
                        console.log("adding texture",tex);
                        let img = document.createElement('img')
                        img.src = tex.src;
                        div.append(img);
                        img.addEventListener('click',(e)=>{
                            e.preventDefault();
                            e.stopPropagation()
                            console.log(`chose this image ${i}`,i)
                            this.queries.active.results.forEach(ent=>{
                                ent.getMutableComponent(ActiveBlock).type = i
                            })
                        })
                    })
                })
                let dismiss = document.createElement('button');
                dismiss.innerHTML = "dismiss"
                dismiss.addEventListener('click',()=>{
                    this.queries.visible.results.forEach(ent => {
                        ent.removeComponent(DashboardVisible)
                    })
                })
                div.append(dismiss)
                dash.domElement = div
            })
            this.queries.visible.added.forEach(ent => {
                console.log("made visible")
                ent.getMutableComponent(DomDashboard).domElement.classList.add('visible')
            })
            this.queries.visible.removed.forEach(ent => {
                console.log("made in-visible")
                ent.getMutableComponent(DomDashboard).domElement.classList.remove('visible')
            })
        }
    }
    DashboardDOMOvleraySystem.queries = {
        dash: {
            components:[DomDashboard],
            listen: {
                added:true,
            }
        },
        visible: {
            components:[DashboardVisible, DomDashboard],
            listen: {
                added:true,
                removed:true,
            }
        },
        textures: {
            components:[VoxelTextures],
        },
        active: {
            components:[ActiveBlock]
        },
    }



    const Y_AXIS = new Vector3(0,1,0)
    const SPEED = 0.1

    // Create a new world to hold all our highlights and systems
    let world = new World();

    // Register all of the systems we will need
    world.registerSystem(VoxelSystem)
    world.registerSystem(KeyboardSystem)
    world.registerSystem(MouseSystem)
    world.registerSystem(HighlightSystem)
    world.registerSystem(DashboardDOMOvleraySystem)
    world.registerSystem(WebXRSystem);
    world.registerSystem(FullscreenSystem);

    // Initialize the default sets of highlights and systems
    let data = initialize(world);
    let {scene, renderer, camera} = data.entities;
    console.log("got it",data)

    // Modify the position for the default camera
    // let transform = camera.getMutableComponent(Transform);
    // transform.position.z = 5;

    scene.addComponent(FullscreenButton);
    scene.addComponent(WebXRButton);



    new TextureLoader().load('./dummy.jpg')


    // add a dashboard to the scene
    let dashboard = scene.addComponent(DomDashboard)
        .addComponent(DashboardVisible)

    //set the active block to type 3 (TNT)
    scene.addComponent(ActiveBlock, {type:3})

    // a pivot for rotating the world around
    let stageRot = world.createEntity()
        .addComponent(Object3D, {value: new Group()})
        .addComponent(Transform)
        .addComponent(Parent, {value: scene})
        .addComponent(KeyboardControls, { mapping: {
                ArrowLeft:(ent) => {
                    let trans = ent.getMutableComponent(Transform)
                    trans.rotation.y -= util.toRad(3)
                },
                ArrowRight: (ent) => {
                    let trans = ent.getMutableComponent(Transform)
                    trans.rotation.y += util.toRad(3)
                }
            }})
        .addComponent(StageRotation) // StageRotation is how the rest of the system can use this

    // a position for moving the world around
    let stagePos = world.createEntity()
        .addComponent(Object3D, {value: new Group})
        .addComponent(Transform)
        .addComponent(Parent, {value:stageRot})
        .addComponent(KeyboardControls, { mapping: {
                ArrowUp:(ent) => {
                    let trans = ent.getMutableComponent(Transform)
                    let stageRot = ent.getComponent(Parent).value
                    const dir = new Vector3(0,0,1)
                    dir.applyAxisAngle(Y_AXIS, -stageRot.getComponent(Transform).rotation.y)
                    let d2 = dir.normalize().multiplyScalar(SPEED)
                    const vel = d2.multiplyScalar(4)
                    trans.position.x += vel.x;
                    trans.position.z += vel.z;
                },
                ArrowDown: (ent) => {
                    let trans = ent.getMutableComponent(Transform)
                    let stageRot = ent.getComponent(Parent).value
                    const dir = new Vector3(0,0,1)
                    dir.applyAxisAngle(Y_AXIS, -stageRot.getComponent(Transform).rotation.y)
                    let d2 = dir.normalize().multiplyScalar(SPEED)
                    const vel = d2.multiplyScalar(-4)
                    trans.position.x += vel.x;
                    trans.position.z += vel.z;
                },
                a:(ent) => {
                    console.log("slide left");
                },
                d:(ent) => {
                    console.log("slide right");
                },
                t:(ent) => {
                    console.log("need to show the dashboard")
                    dashboard.addComponent(DashboardVisible)
                }
            }})
        .addComponent(StagePosition) // StagePosition

    //make the actual landscape
    world.createEntity()
        .addComponent(Transform)
        .addComponent(Parent, {value: stagePos})
        .addComponent(VoxelLandscape, {
            make_voxel: (x,y,z) => {
                // make a floor between -2 and -5
                if(y < -2 && y > -5) return 1 // grass
                // make a 4x4x4 cube floating in space
                if(    x > 0 && x < 5
                    && z > 5 && z < 10
                    && y > 5 && y < 10
                ) return 2 // brick
                return 0
            }
            ,
        })
        .addComponent(VoxelTextures,{
            textures:[
                {
                    src:'./textures/dirt.png'
                },
                {
                    src:'./textures/grass.png'
                },
                {
                    src:'./textures/brick.png'
                },
                {
                    src:'./textures/tnt.png'
                },
                {
                    src:'./textures/heart.png',
                },
        ]})

    world.execute();

    // create a mouse cursor so that we can look for mouse events
    world.createEntity()
        .addComponent(MouseCursor)

    //create a ThreeJS mesh as the highlighter
    let mesh = new Mesh(
        new CubeGeometry(1.1,1.1,1.1, 4,4,4).translate(0.5,0.5,0.5),
        new MeshLambertMaterial({
            color:'green',
            depthTest:true,
            wireframe:true,
            wireframeLinewidth: 3,
            transparent: true,
            opacity: 0.5,
        }));

    // make the highlighter
    let highlight = world.createEntity()
        .addComponent(Transform)
        .addComponent(Object3D, { value: mesh})
        .addComponent(Parent, {value: stagePos})
        .addComponent(Highlight)

    //add some ambient light or the highlight mesh won't have any color
    world.createEntity()
        .addComponent(Object3D, { value: new AmbientLight()})
        .addComponent(Parent, {value: scene})


</script>

</body>
</html>
